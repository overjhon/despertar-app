name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  core_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: ci-debug
        run: |
          node -v
          npm -v
          pwd
          ls -la
      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
      - name: Import project
        run: npm run import-project
      - name: Sync dependencies
        run: npm run sync-deps
      - name: Inject env placeholders
        run: |
          echo "VITE_SUPABASE_URL=https://example.supabase.co" >> .env
          echo "VITE_SUPABASE_PUBLISHABLE_KEY=public-anon-key" >> .env
          echo "VITE_SUPABASE_PROJECT_ID=example" >> .env
      - name: Build Vite
        run: npm run build
      - name: Validate Supabase
        run: npm run validate:supabase || true
      - name: Validate Vercel
        run: npm run validate:vercel || true
      - name: Validate Payload
        run: npm run validate:payload || true

  matrix_smoke:
    strategy:
      matrix:
        os: [ windows-latest, macos-latest ]
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
      - name: Import project
        run: npm run import-project || true
      - name: Sync dependencies
        run: npm run sync-deps || true
      - name: Inject env placeholders
        shell: bash
        run: |
          echo "VITE_SUPABASE_URL=https://example.supabase.co" >> .env
          echo "VITE_SUPABASE_PUBLISHABLE_KEY=public-anon-key" >> .env
      - name: Build Vite
        run: npm run build || true